#include "tncrypt/cipher/tn_magma.h"

#ifdef TN_TEST
#include "unity.h"
#endif // TN_TEST

static tn_u8_t s_box[8][16] = 
{
    { 
        0x0C, 0x04, 0x06, 0x02, 0x0A, 0x05, 0x0B, 0x09, 
        0x0E, 0x08, 0x0D, 0x07, 0x00, 0x03, 0x0F, 0x01 
    },
    { 
        0x06, 0x08, 0x02, 0x03, 0x09, 0x0A, 0x05, 0x0C, 
        0x0B, 0x0E, 0x04, 0x07, 0x01, 0x0D, 0x00, 0x0F 
    },
    { 
        0x0B, 0x03, 0x05, 0x08, 0x02, 0x0F, 0x0A, 0x0D, 
        0x0E, 0x01, 0x07, 0x04, 0x0C, 0x09, 0x06, 0x00 
    },
    { 
        0x0C, 0x08, 0x02, 0x01, 0x0D, 0x04, 0x0F, 0x06, 
        0x07, 0x00, 0x0A, 0x05, 0x03, 0x0E, 0x09, 0x0B 
    },
    { 
        0x07, 0x0F, 0x05, 0x0A, 0x08, 0x01, 0x06, 0x0D, 
        0x00, 0x09, 0x03, 0x0E, 0x0B, 0x04, 0x02, 0x0C 
    },
    { 
        0x05, 0x0D, 0x0F, 0x06, 0x09, 0x02, 0x0C, 0x0A, 
        0x0B, 0x07, 0x08, 0x01, 0x04, 0x03, 0x0E, 0x00 
    },
    { 
        0x08, 0x0E, 0x02, 0x05, 0x06, 0x09, 0x01, 0x0C, 
        0x0F, 0x04, 0x0B, 0x00, 0x0D, 0x0A, 0x03, 0x07 
    },
    { 
        0x01, 0x07, 0x0E, 0x0D, 0x00, 0x05, 0x08, 0x03, 
        0x04, 0x0F, 0x0A, 0x06, 0x09, 0x0C, 0x0B, 0x02 
    }
};

static inline tn_u32_t t(tn_u32_t _a)
{
    return s_box[7][(_a >> 28) & 0x0F] << 28 |
        s_box[6][(_a >> 24) & 0x0F] << 24 |
        s_box[5][(_a >> 20) & 0x0F] << 20 |
        s_box[4][(_a >> 16) & 0x0F] << 16 |
        s_box[3][(_a >> 12) & 0x0F] << 12 |
        s_box[2][(_a >> 8)  & 0x0F] << 8 |
        s_box[1][(_a >> 4)  & 0x0F] << 4 |
        s_box[0][(_a)       & 0x0F];
}

#ifdef TN_TEST
static void test_t()
{
    TEST_ASSERT(t(0xFDB97531) == 0x2A196F34);
    TEST_ASSERT(t(0x2A196F34) == 0XEBD9F03A);
    TEST_ASSERT(t(0XEBD9F03A) == 0XB039BB3D);
    TEST_ASSERT(t(0XB039BB3D) == 0X68695433);
}
#endif // TN_TEST

static inline tn_u32_t g(tn_u32_t _a, tn_u32_t _key)
{
    tn_u32_t a = t(_a + _key);
    return a << 11 | a >> 21;
}

#ifdef TN_TEST
static void test_g()
{
    TEST_ASSERT(g(0xFEDCBA98, 0x87654321) == 0xFDCBC20C);
    TEST_ASSERT(g(0x87654321, 0xFDCBC20C) == 0x7E791A4B);
    TEST_ASSERT(g(0xFDCBC20C, 0x7E791A4B) == 0xC76549EC);
    TEST_ASSERT(g(0x7E791A4B, 0xC76549EC) == 0x9791C849);
}
#endif // TN_TEST

static inline tn_u64_t G(tn_u64_t _a, tn_u32_t _key)
{
    return _a << 32 | (g((tn_u32_t)_a, _key) + (_a >> 32));
}

#ifdef TN_TEST
static void test_G()
{
    TEST_ASSERT(G(0xFEDCBA98, 0x87654321) == 0xFDCBC20C);
    TEST_ASSERT(G(0x87654321, 0xFDCBC20C) == 0x7E791A4B);
    TEST_ASSERT(G(0xFDCBC20C, 0x7E791A4B) == 0xC76549EC);
    TEST_ASSERT(G(0x7E791A4B, 0xC76549EC) == 0x9791C849);
}
#endif // TN_TEST

static inline tn_u64_t G_(tn_u64_t _a, tn_u32_t _key)
{
    return ((g((tn_u32_t)_a, _key) + (_a >> 32)) << 32) | _a & 0x00000000FFFFFFFF;
}

#ifdef TN_TEST
static void test_G_()
{
    TEST_ASSERT(G(0xFEDCBA98, 0x87654321) == 0xFDCBC20C);
    TEST_ASSERT(G(0x87654321, 0xFDCBC20C) == 0x7E791A4B);
    TEST_ASSERT(G(0xFDCBC20C, 0x7E791A4B) == 0xC76549EC);
    TEST_ASSERT(G(0x7E791A4B, 0xC76549EC) == 0x9791C849);
}
#endif // TN_TEST

static inline tn_u32_t round_key(tn_u256_t* _key, tn_u8_t _round)
{
    if (_round < 24)
    {
        return _key->u32[_round % 8];
    }
    
    return _key->u32[7 - (_round % 8)];
}

#ifdef TN_TEST
static void test_round_key()
{
    tn_u256_t key = 
    { 
        0xFF, 0xEE, 0xDD, 0xCC, 0xBB, 0xAA, 0x99, 0x88, 0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11, 0x00, 
        0xF0, 0xF1, 0xF2, 0xF3, 0xF4, 0xF5, 0xF6, 0xF7, 0xF8, 0xF9, 0xFA, 0xFB, 0xFC, 0xFD, 0xFE, 0xFF
    };

    TEST_ASSERT(round_key(&key, 0) == 0xFFEEDDCC);
    TEST_ASSERT(round_key(&key, 1) == 0xBBAA9988);
    TEST_ASSERT(round_key(&key, 2) == 0x77665544);
    TEST_ASSERT(round_key(&key, 3) == 0x33221100);
    TEST_ASSERT(round_key(&key, 4) == 0xF0F1F2F3);
    TEST_ASSERT(round_key(&key, 5) == 0xF4F5F6F7);
    TEST_ASSERT(round_key(&key, 6) == 0xF8F9FAFB);
    TEST_ASSERT(round_key(&key, 7) == 0xFCFDFEFF);
    TEST_ASSERT(round_key(&key, 8) == 0xFFEEDDCC);
    TEST_ASSERT(round_key(&key, 9) == 0xBBAA9988);
    TEST_ASSERT(round_key(&key, 10) == 0x77665544);
    TEST_ASSERT(round_key(&key, 29) == 0x77665544);
    TEST_ASSERT(round_key(&key, 30) == 0xBBAA9988);
    TEST_ASSERT(round_key(&key, 31) == 0xFFEEDDCC);
}
#endif // TN_TEST

#ifdef TN_TEST
void test_magma()
{
    RUN_TEST(test_t);
    RUN_TEST(test_g);
    RUN_TEST(test_G);
    RUN_TEST(test_G_);
    RUN_TEST(test_round_key);
}
#endif // TN_TEST

