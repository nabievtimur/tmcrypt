#include "tncrypt/cipher/tn_magma.h"

#ifdef TN_TEST
#include "unity.h"
#endif // TN_TEST

static tn_u8_t s_box[8][16] = 
{
    { 
        0x0C, 0x04, 0x06, 0x02, 0x0A, 0x05, 0x0B, 0x09, 
        0x0E, 0x08, 0x0D, 0x07, 0x00, 0x03, 0x0F, 0x01 
    },
    { 
        0x06, 0x08, 0x02, 0x03, 0x09, 0x0A, 0x05, 0x0C, 
        0x0B, 0x0E, 0x04, 0x07, 0x01, 0x0D, 0x00, 0x0F 
    },
    { 
        0x0B, 0x03, 0x05, 0x08, 0x02, 0x0F, 0x0A, 0x0D, 
        0x0E, 0x01, 0x07, 0x04, 0x0C, 0x09, 0x06, 0x00 
    },
    { 
        0x0C, 0x08, 0x02, 0x01, 0x0D, 0x04, 0x0F, 0x06, 
        0x07, 0x00, 0x0A, 0x05, 0x03, 0x0E, 0x09, 0x0B 
    },
    { 
        0x07, 0x0F, 0x05, 0x0A, 0x08, 0x01, 0x06, 0x0D, 
        0x00, 0x09, 0x03, 0x0E, 0x0B, 0x04, 0x02, 0x0C 
    },
    { 
        0x05, 0x0D, 0x0F, 0x06, 0x09, 0x02, 0x0C, 0x0A, 
        0x0B, 0x07, 0x08, 0x01, 0x04, 0x03, 0x0E, 0x00 
    },
    { 
        0x08, 0x0E, 0x02, 0x05, 0x06, 0x09, 0x01, 0x0C, 
        0x0F, 0x04, 0x0B, 0x00, 0x0D, 0x0A, 0x03, 0x07 
    },
    { 
        0x01, 0x07, 0x0E, 0x0D, 0x00, 0x05, 0x08, 0x03, 
        0x04, 0x0F, 0x0A, 0x06, 0x09, 0x0C, 0x0B, 0x02 
    }
};

static inline tn_u32_t t(tn_u32_t _a)
{
    return s_box[7][(_a >> 28) & 0x0F] << 28 |
        s_box[6][(_a >> 24) & 0x0F] << 24 |
        s_box[5][(_a >> 20) & 0x0F] << 20 |
        s_box[4][(_a >> 16) & 0x0F] << 16 |
        s_box[3][(_a >> 12) & 0x0F] << 12 |
        s_box[2][(_a >> 8)  & 0x0F] << 8 |
        s_box[1][(_a >> 4)  & 0x0F] << 4 |
        s_box[0][(_a)       & 0x0F];
}

#ifdef TN_TEST
static void test_t()
{
    TEST_ASSERT(t(0xFDB97531) == 0x2A196F34);
    TEST_ASSERT(t(0x2A196F34) == 0XEBD9F03A);
    TEST_ASSERT(t(0XEBD9F03A) == 0XB039BB3D);
    TEST_ASSERT(t(0XB039BB3D) == 0X68695433);
}
#endif // TN_TEST

static inline tn_u32_t g(tn_u32_t _a, tn_u32_t _key)
{
    tn_u32_t a = t(_a + _key);
    return a << 11 | a >> 21;
}

#ifdef TN_TEST
static void test_g()
{
    TEST_ASSERT(g(0xFEDCBA98, 0x87654321) == 0xFDCBC20C);
    TEST_ASSERT(g(0x87654321, 0xFDCBC20C) == 0x7E791A4B);
    TEST_ASSERT(g(0xFDCBC20C, 0x7E791A4B) == 0xC76549EC);
    TEST_ASSERT(g(0x7E791A4B, 0xC76549EC) == 0x9791C849);
}
#endif // TN_TEST

#ifdef TN_TEST
void test_magma()
{
    RUN_TEST(test_t);
    RUN_TEST(test_g);
}
#endif // TN_TEST

